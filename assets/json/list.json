{"list": [{"id":"9a5CggpRC5uwPHfMfWFAl","title":"ä»¿æŠ–éŸ³å·¦å³æ­ªå¤´å›¾ç‰‡é€‰æ‹©","keywords":["face-api"," äººè„¸è¯†åˆ«"," æŠ–éŸ³"],"date":"2022-11-29","fileName":"face-api","content":"\n- [åœ¨çº¿ä½“éªŒ](https://srect.github.io/face-api.js)\n\n- [é¡¹ç›® github ä»“åº“](https://github.com/sRect/face-api.js/tree/dy)\n\n> å‰ä¸€é˜µå­åœ¨åˆ·æŠ–éŸ³æ—¶ï¼Œçœ‹åˆ°ä¸€ä¸ªé€šè¿‡å·¦å³æ­ªå¤´é€‰æ‹©ä¸¤ä¾§å›¾ç‰‡çš„è§†é¢‘ï¼Œæ„Ÿè§‰å¾ˆæœ‰è¶£ã€‚é¡¿æ—¶æƒ³åˆ°äº† n å¹´å‰çš„[**face-api.js**](https://github.com/justadudewhohacks/face-api.js)ï¼Œé‚£å°±åŸºäºè¿™ä¸ªæ¥åšå§ã€‚æ€»ä½“åšå¥½åï¼Œæœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦æ”¹è¿›ï¼Œä¸å¤Ÿç»†è…»ä¸æ»‘ã€‚\n\n### 1. éœ€æ±‚åˆ†æ\n\nç›´æ¥å¼€æå§ï¼\n\n1. é¡µé¢åŸºæœ¬å¸ƒå±€ï¼Œå·¦å³ä¸¤ä¾§å›¾ç‰‡ï¼Œè€Œä¸”æœ‰ç¼©æ”¾å’Œç§»åŠ¨åŠ¨ç”»\n2. éœ€è¦æ‰“å¼€æ‘„åƒå¤´ï¼Œè·å–è§†é¢‘æµï¼Œé€šè¿‡ video å±•ç°å‡ºæ¥\n3. éœ€è¦æ£€æµ‹äººè„¸æ˜¯å‘å“ªä¸€ä¾§æ­ªå¤´\n\n### 2. å…·ä½“å®ç°\n\n#### 2.1 é¡µé¢å¸ƒå±€å’Œ animation åŠ¨ç”»\n\nè¿™ä¸ªä¸éš¾ï¼Œå¸ƒå±€å¥½åï¼Œå°±æ˜¯æ·»åŠ  css åŠ¨ç”»ï¼Œæˆ‘è¿™é‡Œå†™çš„å¾ˆç²—ç³™ï¼Œä¸ç»†è…»ï¼Œä½†å‹‰å¼ºèƒ½ç”¨ï¼Œä¾‹å¦‚ä¸‹é¢ _leftHeartMove_ ä¸ºä¸­é—´çš„å°çˆ±å¿ƒå‘å·¦ä¾§ç§»åŠ¨åŠ¨ç”»\n\n```css\n.heart {\n  width: 30px;\n  height: 30px;\n  padding: 4px;\n  box-sizing: border-box;\n  border-radius: 50%;\n  background-color: #fff;\n  position: absolute;\n  top: -15px;\n  left: 50%;\n  transform: translateX(-50%) rotateZ(0deg) scale(1);\n  animation: leftHeartMove 0.5s linear;\n  animation-fill-mode: forwards;\n  z-index: 2;\n}\n\n@keyframes leftHeartMove {\n  from {\n    top: -15px;\n    left: 50%;\n    transform: translateX(-50%) rotateZ(0deg) scale(1);\n  }\n\n  to {\n    top: 65px;\n    left: -13%;\n    transform: translateX(-50%) rotateZ(-15deg) scale(1.2);\n  }\n}\n```\n\n#### 2.2 æ‰“å¼€æ‘„åƒå¤´å¹¶æ˜¾ç¤º\n\n**æ³¨æ„ç‚¹**\n\n1. å…³äº h5`navigator.mediaDevices.getUserMedia` è¿™ä¸ª apiï¼Œæœ¬åœ°å¼€å‘`localhost`æ˜¯å¯ä»¥æ‹‰èµ·æ‘„åƒå¤´æ‰“å¼€æç¤ºçš„ï¼Œçº¿ä¸Šéƒ¨ç½²å¿…é¡»æ˜¯`https`èŠ‚ç‚¹æ‰è¡Œï¼Œ`http`ä¸èƒ½å”¤èµ·æ‰“å¼€æ‘„åƒå¤´\n\n![](../img/face-api/WX20221128-221028@2x.png)\n\n2. å…³äºè·å–åˆ°è§†é¢‘æµåï¼Œ`video`è§†é¢‘æ’­æ”¾ï¼Œéœ€è¦é•œé¢ç¿»è½¬ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡ css çš„`transform: rotateY(180deg)`æ¥ç¿»è½¬\n\n3. å…³äº`video`æ’­æ”¾ä¸èƒ½åœ¨æ‰‹æœºä¸Šç«–å±å…¨å±ï¼Œå¯ä»¥ç»™ video è®¾ç½® css`object-fit:cover`æ¥å……æ»¡å±å¹•\n\n```html\n<video id=\"video\" class=\"video\" playsinline autoplay muted></video>\n```\n\n```css\n.video {\n  width: 100%;\n  height: 100%;\n  transform: rotateY(180deg);\n  object-fit: cover;\n}\n```\n\n- è·å–æ‘„åƒå¤´è§†é¢‘æµ\n\n```javascript\nasync getUserMedia() {\n  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\n    try {\n      // https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia#examples\n      const stream = await navigator.mediaDevices.getUserMedia({\n        audio: false,\n        video: true,\n        video: {\n          facingMode: \"user\", // å‰ç½®æ‘„åƒå¤´\n          // facingMode: { exact: \"environment\" }ï¼Œ// åç½®æ‘„åƒå¤´\n          width: { min: 1280, max: 1920 },\n          height: { min: 720, max: 1080 },\n        },\n      });\n\n      return Promise.resolve(stream);\n    } catch (error) {\n      return Promise.reject();\n    }\n  }\n\n  const errorMessage =\n    \"This browser does not support video capture, or this device does not have a camera\";\n  alert(errorMessage);\n}\n```\n\n- video æ’­æ”¾è§†é¢‘æµ\n\n```javascript\nasync openCamera(e) {\n  try {\n    const stream = await this.getUserMedia();\n    this.video.srcObject = stream;\n    this.video.onloadedmetadata = async () => {\n      this.video.play();\n    };\n  } catch (error) {\n    console.log(error);\n    alert(\"æ‰“å¼€æ‘„åƒå¤´å¤±è´¥\");\n  }\n}\n```\n\n- å…³é—­è§†é¢‘\n\n```javascript\nasync closeCamera() {\n  // https://developer.mozilla.org/en-US/docs/Web/API/MediaStreamTrack/stop\n  const tracks = this.video.srcObject.getTracks();\n\n  tracks.forEach((track) => {\n    track.stop();\n  });\n\n  this.video.srcObject.srcObject = null;\n}\n```\n\n#### 2.3 æ£€æµ‹äººè„¸å·¦å³å€¾æ–œ\n\n![](../img/face-api/landmarks.png)\n\né€šè¿‡`face-api.js`æ‹¿åˆ°äººè„¸`landmarks`ç‰¹å¾æ•°æ®åï¼Œå¯ä»¥ç›´æ¥æ‹¿åˆ°å·¦å³çœ¼çš„æ•°æ®ï¼Œåˆ†åˆ«é€šè¿‡æ±‚ Y è½´æ–¹å‘çš„å¹³å‡å€¼ï¼Œç„¶åæ¯”è¾ƒè¿™ä¸ªå¹³å‡å€¼ï¼Œä¾¿å¯ä»¥ç®€å•å¾—å‡ºäººè„¸å‘å·¦è¿˜æ˜¯å‘å³å€¾æ–œï¼Œç®€å•å§ï¼Œè§’åº¦éƒ½ä¸ç”¨æ±‚äº†ï¼\n\n```html\n<div style=\"position: relative;width: 100%;height: 100%;\">\n  <video\n    id=\"video\"\n    class=\"video\"\n    playsinline\n    autoplay\n    muted\n    style=\"object-fit:cover\"\n  ></video>\n  <canvas id=\"overlay\" class=\"overlay\"></canvas>\n</div>\n```\n\n```css\n.video {\n  width: 100%;\n  height: 100%;\n  position: absolute;\n  top: 0;\n  left: 0;\n  z-index: 0;\n  transform: rotateY(180deg);\n}\n\n.overlay {\n  position: absolute;\n  top: 0;\n  left: 0;\n}\n```\n\n- åŠ è½½æ¨¡å‹\n\n```javascript\nimport * as faceapi from \"face-api.js\";\n\nasync loadWeight() {\n  // åŠ è½½æ¨¡å‹\n  await faceapi.nets.ssdMobilenetv1.load(\n    \"./static/weights/ssd_mobilenetv1_model-weights_manifest.json\"\n  );\n  // åŠ è½½äººè„¸68ç‰¹å¾æ¨¡å‹æ•°æ®\n  await faceapi.nets.faceLandmark68Net.load(\n    \"./static/weights/face_landmark_68_model-weights_manifest.json\"\n  );\n  // await faceapi.nets.faceExpressionNet.load(\n  //   \"/static/weights/face_expression_model-weights_manifest.json\"\n  // );\n  // await faceapi.nets.faceRecognitionNet.load(\n  //   \"./static/weights/face_recognition_model-weights_manifest.json\"\n  // );\n  await faceapi.nets.ageGenderNet.load(\n    \"./static/weights/age_gender_model-weights_manifest.json\"\n  );\n\n  console.log(\"æ¨¡å‹åŠ è½½å®Œæˆ\");\n}\n```\n\n- è®¡ç®—äººè„¸å·¦å³å€¾æ–œ\n\n```javascript\nhandleFaceLeftOrRight(landmarks) {\n  const DIFF_NUM = 15; // åå·®\n  let leftEye = landmarks.getLeftEye(); // å·¦çœ¼æ•°æ®\n  let rightEye = landmarks.getRightEye(); // å³çœ¼æ•°æ®\n  // let nose = landmarks.getNose();\n\n  let leftEyeSumPoint = leftEye.reduce((prev, cur) => ({\n    x: prev.x + cur.x,\n    y: prev.y + cur.y,\n  }));\n\n  let rightEyeSumPoint = rightEye.reduce((prev, cur) => ({\n    x: prev.x + cur.x,\n    y: prev.y + cur.y,\n  }));\n\n  // let noseSumPoint = nose.reduce((prev, cur) => ({\n  //   x: prev.x + cur.x,\n  //   y: prev.y + cur.y,\n  // }));\n\n  let leftEyeAvgPoint = {\n    x: leftEyeSumPoint.x / leftEye.length,\n    y: leftEyeSumPoint.y / leftEye.length,\n  };\n\n  let rightEyeAvgPoint = {\n    x: rightEyeSumPoint.x / leftEye.length,\n    y: rightEyeSumPoint.y / leftEye.length,\n  };\n\n  // let noseAvgPoint = {\n  //   x: noseSumPoint.x / leftEye.length,\n  //   y: noseSumPoint.y / leftEye.length,\n  // };\n\n  // console.log(leftEyeAvgPoint, rightEyeAvgPoint, noseAvgPoint);\n  let diff = Math.abs(leftEyeAvgPoint.y - rightEyeAvgPoint.y);\n\n  return diff > DIFF_NUM\n    ? leftEyeAvgPoint.y > rightEyeAvgPoint.y\n      ? \"left\"\n      : \"right\"\n    : \"center\";\n}\n```\n\n- åˆ†æ video è§†é¢‘æµ\n\n```javascript\nasync handleVideoFaceTracking(cb) {\n    if (this.closed) {\n      window.cancelAnimationFrame(this.raf);\n      return;\n    }\n\n    const options = new faceapi.SsdMobilenetv1Options();\n\n    let task = faceapi.detectAllFaces(this.video, options);\n    task = task.withFaceLandmarks().withAgeAndGender();\n    const results = await task;\n\n    // overlayä¸ºcanvaså…ƒç´ \n    // videoå³ä¸ºvideoå…ƒç´ \n    const dims = faceapi.matchDimensions(this.overlay, this.video, true);\n    const resizedResults = faceapi.resizeResults(results, dims);\n\n    // console.log(\"options==>\", options);\n    // console.log(\"resizedResults==>\", resizedResults);\n    cb && cb(resizedResults);\n\n    this.raf = requestAnimationFrame(() => this.handleVideoFaceTracking(cb));\n  }\n```\n\n### 3. å‚è€ƒèµ„æ–™\n\n1. [face-api.js](https://github.com/justadudewhohacks/face-api.js)\n\n2. [getUserMedia MDN](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia#examples)\n"},{"id":"n55_1Ve1eYvIlm9Hq6VRq","title":"uniapp æ‰“åŒ… h5 é—®é¢˜æ€»ç»“","keywords":["uniapp"," webpack4.x"],"date":"2022-08-08 22:15:07","fileName":"uniapp","content":"\n[æœ¬æ–‡æ˜é‡‘é“¾æ¥](https://juejin.cn/post/7129492032241795080/)\n\n# uniapp æ‰“åŒ… h5 é—®é¢˜æ€»ç»“\n\n![ ](../img/uniapp/banner.jpeg)\n\næœ¬æ–‡å¯¹åº”æ“ä½œç³»ç»ŸåŠ hbuilderx ç‰ˆæœ¬ç­‰\n\n| -         | -               |\n| --------- | --------------- |\n| æ“ä½œç³»ç»Ÿ  | macOS           |\n| HbuilderX | 3.4.18.20220630 |\n| Vue       | 2.x             |\n| uView     | 1.x             |\n\n---\n\n## 1. é¡¹ç›®èƒŒæ™¯\n\nè¿™æ˜¯ä¸€ä¸ªåµŒå¥—åœ¨ flutter é‡Œçš„ h5 é¡¹ç›®ï¼Œå¤–é¢å£³å­æ˜¯ appï¼Œé‡Œé¢å¤§éƒ¨åˆ†çš„é¡µé¢æ˜¯ h5ï¼Œapp ç›´æ¥ç”¨ webview æ˜¾ç¤º h5 é¡µé¢\n\n## 2. å¼€å‘ h5 ä¸ºä»€ä¹ˆè¦ç”¨ uniapp?\n\nå› ä¸ºè¿˜è¦å¼€å‘å¾®ä¿¡å°ç¨‹åºï¼Œä½¿ç”¨ uniappï¼Œå¯ä»¥è·¨å¹³å°ï¼ŒèŠ‚çœæ—¶é—´\n\n## 3. é¡¹ç›®åˆå§‹åŒ–\n\né¡¹ç›®åˆå§‹åŒ–æ˜¯ä½¿ç”¨[HBuilderX å¯è§†åŒ–ç•Œé¢](https://uniapp.dcloud.net.cn/quickstart-hx.html)åˆ›å»ºçš„é¡¹ç›®ï¼Œæ²¡æœ‰ä½¿ç”¨[vue-cli å‘½ä»¤è¡Œ](https://uniapp.dcloud.net.cn/quickstart-cli.html)çš„æ–¹å¼ã€‚\n\né€šè¿‡å®˜æ–¹ IDE çš„æ–¹å¼åˆ›å»ºçš„é¡¹ç›®ï¼Œè¿™ç»™åé¢é¡¹ç›® CI/CD æ„å»ºéƒ¨ç½²ï¼Œå°±å¸¦æ¥äº†éº»çƒ¦ã€‚å› ä¸ºä¸æ˜¯å‘½ä»¤è¡Œåˆ›å»ºçš„é¡¹ç›®ï¼Œæ²¡æ³•åœ¨ linux é‡Œæ‰§è¡Œå‘½ä»¤ï¼Œåªæœ‰åœ¨æœ¬åœ°æ‰“åŒ…å®Œï¼Œç„¶åä¸Šä¼ æ‰“åŒ…å®Œçš„`unpackage`ç›®å½•è¿›è¡Œéƒ¨ç½²ã€‚å½“ç„¶ä½¿ç”¨ HBuilderX ä¹Ÿæœ‰å¾ˆå¤šæ–¹ä¾¿çš„åœ°æ–¹ã€‚\n\n### 3.1 uni-app HBuilderX å·¥ç¨‹ä¸ vue-cli å·¥ç¨‹ç›¸äº’è½¬æ¢\n\n[HBuilderX å·¥ç¨‹è½¬æ¢ä¸º vue-cli å·¥ç¨‹](https://ask.dcloud.net.cn/article/35750)ï¼Œçœ‹åˆ°è¯„è®ºåŒºæœ‰å‘ï¼Œè€Œä¸”é¡¹ç›®ä¸€å¤§ï¼Œé‡åˆ°å‘ä¸ä¸€å®šèƒ½è§£å†³æ‰ï¼Œè¿™æ ·ä»£ä»·å°±å¤§äº†ã€‚\n\n### 3.2 é€šè¿‡ HBuilderX æ–¹å¼åˆ›å»ºçš„é¡¹ç›®ï¼Œå¯ä»¥è°ƒç”¨ hbuilderx çš„æ‰“åŒ…å‘½ä»¤å—ï¼Ÿ\n\nä¹Ÿå°±æ˜¯é€šè¿‡å‘½ä»¤è¡Œè°ƒç”¨ hbuilderx çš„æ‰“åŒ…åŠŸèƒ½\n\n- [CLI å‘è¡Œ uni-app åˆ° H5](https://hx.dcloud.net.cn/cli/publish-h5)\n- [cli é…ç½®ç¯å¢ƒå˜é‡](https://hx.dcloud.net.cn/cli/env)\n\nä½†æ˜¯è¿™æ ·è¿˜æ˜¯æ²¡æœ‰ä¸€å¼€å§‹é€šè¿‡ vue-cli å‘½ä»¤è¡Œçš„æ–¹å¼æ–¹ä¾¿ï¼Œè€Œä¸”éƒ½æ˜¯åœ¨æœ¬åœ° windows æˆ–è€… mac ä¸Šæ‰“åŒ…ï¼Œæ²¡æ³•åœ¨ linux ä¸Šé€šè¿‡ shell è„šæœ¬æ‰§è¡Œæ‰“åŒ…ã€‚æœ€ç»ˆåªèƒ½æ˜¯æœ¬åœ°æ‰“åŒ…å®Œï¼Œä¸Šä¼  git ä»“åº“ã€‚è¿™é‡Œæœ‰ä¼˜é›…çš„è§£å†³æ–¹å¼çš„ï¼Œè¯„è®ºåŒºåˆ†äº«ä¸‹ã€‚\n\n### 3.3 é€šè¿‡ HBuilderX æ–¹å¼åˆ›å»ºçš„é¡¹ç›®ï¼Œå¯ä»¥ä½¿ç”¨ npm å—ï¼Ÿ\n\nå®˜æ–¹æ–‡æ¡£æ˜ç¡®è¯´ï¼Œå¯ä»¥çš„\n\n## 4. ç”Ÿäº§æ‰“åŒ…å»é™¤`console`\n\n[å®˜æ–¹æ–‡æ¡£](https://uniapp.dcloud.net.cn/collocation/vue-config.html)\n\n```javascript\n// vue.config.js\n\nmodule.exports = {\n  chainWebpack: (config) => {\n    // å‘è¡Œæˆ–è¿è¡Œæ—¶å¯ç”¨äº†å‹ç¼©æ—¶ä¼šç”Ÿæ•ˆ\n    config.optimization.minimizer(\"terser\").tap((args) => {\n      const compress = args[0].terserOptions.compress;\n      // é App å¹³å°ç§»é™¤ console ä»£ç (åŒ…å«æ‰€æœ‰ console æ–¹æ³•ï¼Œå¦‚ log,debug,info...)\n      compress.drop_console = true;\n      compress.pure_funcs = [\n        \"__f__\", // App å¹³å° vue ç§»é™¤æ—¥å¿—ä»£ç \n        // 'console.debug' // å¯ç§»é™¤æŒ‡å®šçš„ console æ–¹æ³•\n      ];\n      return args;\n    });\n  },\n};\n```\n\n## 5. HBuilderX åˆ›å»ºçš„é¡¹ç›®æ‰“åŒ…æ—¶å¦‚ä½•åŒºåˆ†ç¯å¢ƒï¼Ÿ\n\næ„æ€å°±æ˜¯ï¼Œå¦‚ä½•åƒæ‰§è¡Œ`npm run build:dev`æ‰§è¡Œçš„æµ‹è¯•ç¯å¢ƒæ‰“åŒ…ï¼Œ`npm run build:prod`æ‰§è¡Œçš„æ˜¯ç”Ÿäº§ç¯å¢ƒæ‰“åŒ…ã€‚\n\n[å®˜æ–¹æ–‡æ¡£](https://uniapp.dcloud.net.cn/collocation/package.html#%E6%A6%82%E8%BF%B0)\n\nè‡ªå®šä¹‰å‘è¡Œ-package.json ä¸­æ·»åŠ é…ç½®\n\n```json\n{\n  \"uni-app\": {\n    \"scripts\": {\n      \"h5-prod\": {\n        \"title\": \"h5:prod\",\n        \"browser\": \"\",\n        \"env\": {\n          \"UNI_PLATFORM\": \"h5\",\n          \"NODE_ENV\": \"production\",\n          \"DEPLOY_ENV\": \"prod\"\n        },\n        \"define\": {\n          \"CUSTOM-CONST\": true\n        }\n      },\n      \"h5-dev\": {\n        \"title\": \"h5:dev\",\n        \"browser\": \"\",\n        \"env\": {\n          \"UNI_PLATFORM\": \"h5\",\n          \"NODE_ENV\": \"development\",\n          \"DEPLOY_ENV\": \"dev\"\n        },\n        \"define\": {\n          \"CUSTOM-CONST\": true\n        }\n      }\n    }\n  }\n}\n```\n\næ·»åŠ åï¼Œæœ¬åœ°å¼€å‘ï¼Œå°±å¯ä»¥åœ¨èœå•`è¿è¡Œ - h5:dev`æœ¬åœ°å¯åŠ¨é¡¹ç›®ï¼Œ`å‘è¡Œ - è‡ªå®šä¹‰å‘è¡Œ - h5:dev`æµ‹è¯•ç¯å¢ƒæ‰“åŒ…ï¼Œå½“ç„¶ç‚¹å‡»`å‘è¡Œ - è‡ªå®šä¹‰å‘è¡Œ - h5:prod`æ˜¯ç”Ÿäº§ç¯å¢ƒæ‰“åŒ…ã€‚\n\n## 6. æ ¹ç›®å½•`vue.config.js`ä¸­å¦‚ä½•è·å–åˆ°è‡ªå®šä¹‰ `process` å˜é‡ï¼Ÿ\n\nå› ä¸ºæƒ³åœ¨æµ‹è¯•ç¯å¢ƒæ‰“åŒ…æ—¶ä¿ç•™ä»£ç ä¸­çš„ debugger æ—¥å¿—ï¼Œç”Ÿäº§ç¯å¢ƒæ‰“åŒ…çš„æ—¶å€™å»é™¤æ—¥å¿—æ‰“å°ã€‚\n\nåƒä¸Šé¢å®šä¹‰çš„`process.env.DEPLOY_ENV`è¿™ä¸ªå˜é‡ï¼Œä¸šåŠ¡ä»£ç ä¸­å¯ä»¥æ­£å¸¸è·å–åˆ°ï¼Œä½†æ˜¯åœ¨ vue.config.js è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸­æ‹¿ä¸åˆ°ã€‚\n\n1. å®‰è£…`dotenv`\n\n```bash\nnpm i dotenv -D\n```\n\n2. ä¿®æ”¹`vue.config.js`\n\n```javascript\nrequire(\"dotenv\").config();\n\nmodule.exports = {\n  chainWebpack(config) {\n    config.when(process.env.NODE_ENV === \"production\", (config) => {\n      // æˆ‘ä»¬å¯ä»¥æ‹¿åˆ°process.env.UNI_SCRIPTè¿™ä¸ªå˜é‡æ¥è¿›è¡Œæ“ä½œ\n      if (process.env.UNI_SCRIPT === \"h5-prod\") {\n        // https://uniapp.dcloud.io/collocation/vue-config.html\n        // å‘è¡Œæˆ–è¿è¡Œæ—¶å¯ç”¨äº†å‹ç¼©æ—¶ä¼šç”Ÿæ•ˆ\n        config.optimization.minimizer(\"terser\").tap((args) => {\n          const compress = args[0].terserOptions.compress;\n          compress.drop_console = true;\n          compress.pure_funcs = [\n            \"__f__\", // App å¹³å° vue ç§»é™¤æ—¥å¿—ä»£ç \n          ];\n          return args;\n        });\n      }\n    });\n  },\n};\n```\n\n## 7. æ‰“åŒ… h5 è¿‡åæ–‡ä»¶åè¿‡é•¿é—®é¢˜\n\né¡¹ç›®ç¨å¾®å¤§ç‚¹ï¼Œé¡µé¢ç›®å½•åµŒå¥—æ·±ä¸€ç‚¹ï¼Œæ‰“åŒ…å‡ºæ¥çš„æ–‡ä»¶åç§°å·¨é•¿ï¼Œç”šè‡³è¾¾åˆ° 100 å­—ç¬¦é•¿åº¦ä»¥ä¸Šã€‚æ–‡ä»¶åè¿‡é•¿ï¼Œå°±ä¼šå¸¦æ¥å¾ˆæ¶å¿ƒçš„é—®é¢˜ï¼Œæ¯”å¦‚è¢« nginx æ‹¦æˆªï¼Œæ‹¿ä¸åˆ°æ–‡ä»¶å†…å®¹ï¼Œå¯¼è‡´é¡µé¢æŒ‚æ‰ã€‚\n\n```javascript\n// vue.config.js\nmodule.exports = {\n  chainWebpack: (config) => {\n    config.when(process.env.NODE_ENV === \"production\", (config) => {\n      config.output\n        .filename(\"static/js/[name]-[contenthash].js\")\n        .chunkFilename(\"static/js/[id]-[chunkhash].js\");\n    });\n\n    config.optimization.splitChunks({\n      name: function (module, chunks, cacheGroupKey) {\n        const moduleFileName = module\n          .identifier()\n          .split(\"/\")\n          .reduceRight((item) => item);\n        const allChunksNames = chunks.map((item) => item.name).join(\"~\");\n        return `${moduleFileName}`;\n      },\n    });\n  },\n};\n```\n\n## 8. æ‰“åŒ… h5 å`chunk-vendors`æ–‡ä»¶ä½“ç§¯è¿‡å¤§ï¼Œè€Œä¸”é¡µé¢éƒ¨ç½²åæ‰“å¼€ä¹Ÿå¾ˆæ…¢\n\nåº†å¹¸çš„æ˜¯ï¼Œæš´éœ²äº†`vue.config.js`è¿™ä¸ªæ–‡ä»¶äº¤ç»™å¼€å‘è€…ï¼Œä¸ç„¶å¤„ç†èµ·æ¥çœŸçš„å¤´å¤§ã€‚\n\n### 8.1 é¦–å…ˆå¯ç”¨`manifest.json`é…ç½®æ–‡ä»¶ä¸­çš„`tree-shaking`é…ç½®ï¼Œâ€œæ‘‡æ‰â€é‚£äº›å†—ä½™ä»£ç \n\n### 8.2 ç§»é™¤ prefetch æ’ä»¶\n\n```javascript\n// è¿™ä¸ªè§†è‡ªå·±çš„é¡¹ç›®è€Œå®š\n// vue.config.js\nmodule.exports = {\n  chainWebpack: (config) => {\n    // ç§»é™¤ prefetch æ’ä»¶\n    // https://cli.vuejs.org/zh/guide/html-and-static-assets.html#prefetch\n    config.plugins.delete(\"prefetch\");\n  },\n};\n```\n\n### 8.3 æ‰“åŒ…è¿›è¡Œ gz æˆ– br å‹ç¼©\n\n1. å®‰è£…`compression-webpack-plugin`\n\n> è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ7.x ç‰ˆæœ¬ååªæ”¯æŒ webpack5.x ç‰ˆæœ¬ï¼Œè¿™é‡Œæ˜¯ webpack4.xï¼Œåªèƒ½ä½¿ç”¨ 6.x ç‰ˆæœ¬\n> https://github.com/webpack-contrib/compression-webpack-plugin/releases?page=2\n\n```txt\n7.0.0 (2020-12-02)\n\nBREAKING CHANGES\n  minimum supported webpack version is ^5.1.0\n```\n\nå®‰è£…\n\n```bash\nnpm i compression-webpack-plugin@6.1.1 -D\n```\n\n2. ä¿®æ”¹ vue.config.js\n\n```javascript\n// vue.config.js\nconst CompressionPlugin = require(\"compression-webpack-plugin\");\n\nmodule.exports = {\n  configureWebpack: (config) => {\n    if (process.env.NODE_ENV === \"production\") {\n      config.plugins.push(\n        new CompressionPlugin({\n          filename: \"[path][base].gz\",\n          algorithm: \"gzip\",\n          test: /\\.(js|css|html)$/,\n          threshold: 10240,\n          minRatio: 0.8,\n          deleteOriginalAssets: false,\n        })\n      );\n    }\n  },\n};\n```\n\n3. åŒæ—¶ nginx å¼€å¯ gzip\n\n```nginx\nserver {\n  gzip on; #å¼€å¯gzip\n  # gzip_buffers 32 4k; #è®¾ç½®å‹ç¼©æ‰€éœ€è¦çš„ç¼“å†²åŒºå¤§å°ï¼Œä»¥4kä¸ºå•ä½ï¼Œå¦‚æœæ–‡ä»¶ä¸º32kåˆ™ç”³è¯·32*4kçš„ç¼“å†²åŒº\n  gzip_comp_level 6; #gzip å‹ç¼©çº§åˆ«ï¼Œ1-9ï¼Œæ•°å­—è¶Šå¤§å‹ç¼©çš„è¶Šå¥½ï¼Œä¹Ÿè¶Šå ç”¨CPUæ—¶é—´\n  gzip_min_length 4000; #gizpå‹ç¼©èµ·ç‚¹ï¼Œæ–‡ä»¶å¤§äº4kæ‰è¿›è¡Œå‹ç¼©\n  gzip_vary on; # æ˜¯å¦åœ¨http headerä¸­æ·»åŠ Vary: Accept-Encodingï¼Œå»ºè®®å¼€å¯\n  gzip_static on; #nginxå¯¹äºé™æ€æ–‡ä»¶çš„å¤„ç†æ¨¡å—ï¼Œå¼€å¯åä¼šå¯»æ‰¾ä»¥.gzç»“å°¾çš„æ–‡ä»¶ï¼Œç›´æ¥è¿”å›ï¼Œä¸ä¼šå ç”¨cpuè¿›è¡Œå‹ç¼©ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™ä¸è¿›è¡Œå‹ç¼©\n  # gzip_types text/xml text/javascript application/javascript text/css text/plain application/json application/x-javascript; # è¿›è¡Œå‹ç¼©çš„æ–‡ä»¶ç±»å‹\n}\n```\n\n### 8.4 ç»“åˆ`webpack-bundle-analyzer`ç”Ÿæˆçš„æ¨¡å—åˆ†æå›¾æ¥æ‹†åˆ† chunk-vendors\n\n#### 8.4.1 å®‰è£…`webpack-bundle-analyzer`\n\n```bash\nnpm i webpack-bundle-analyzer -D\n```\n\n#### 8.4.2 å¼•å…¥`webpack-bundle-analyzer`\n\n```javascript\nconst BundleAnalyzerPlugin =\n  require(\"webpack-bundle-analyzer\").BundleAnalyzerPlugin;\n\nmodule.exports = {\n  configureWebpack: (config) => {\n    config.plugins.push(new BundleAnalyzerPlugin());\n  },\n};\n```\n\nå¦‚ä¸‹å›¾æ‰€ç¤º,chunk-vendors çš„ç»„æˆï¼Œæ˜¯æŠŠé‚£äº›å…¬å…±çš„ä¾èµ–å…¨éƒ¨éƒ½æ‰“åŒ…åœ¨ä¸€èµ·äº†ï¼Œæ–‡ä»¶å¤§å°è¾¾åˆ° 1M ä»¥ä¸Šï¼Œä¸¥é‡å½±å“é¡µé¢åŠ è½½é€Ÿåº¦ï¼Œç”Ÿæˆç¯å¢ƒä¸Š gzip å‹ç¼©åï¼Œé¦–é¡µåŠ è½½ä¹Ÿéœ€è¦å°†è¿‘ 10s å·¦å³ï¼Œä»¤äººæ±—é¢œã€‚(è¿™é‡Œçš„æ‹†åˆ†è§†å…·ä½“é¡¹ç›®è€Œå®š)\n\n![ ](../img/uniapp/old-chunk-vendors.png)\n\n- éœ€è¦å°†`@dcloudio`(658kb)æ‹†åˆ†ä¸º\"uni-h5\"éƒ¨åˆ†å’Œ\"vue-cli-plugin-uni\"éƒ¨åˆ†\n- å°†`core-js`(282kb)å•ç‹¬æ‹†å‡ºæ¥\n- å°†`node-rsa`(112kb)å•ç‹¬æ‹†å‡ºæ¥\n- å°†`bn.js`(88kb)å•ç‹¬æ‹†å‡ºæ¥\n- ...\n\nå…¥å£ index æ–‡ä»¶ä¹Ÿè¾¾åˆ°äº†å‡ ä¹ 350kbï¼Œé‡Œé¢æœ‰ä¸€ä¸ªå¤§çš„ pages.json æ–‡ä»¶\n\n![ ](../img/uniapp/old-index.png)\n\n- å°†`pages.json`(290kb)å•ç‹¬æ‹†å‡ºæ¥\n\nåœ¨æµè§ˆå™¨ä¸Šçœ‹ chunk-vendorsï¼Œè¿˜æœ‰ä¸€ä¸ª`buffer`æ¨¡å—\n\n![ ](../img/uniapp/old-chunk-vendors-js.png)\n\n- å°†`buffer`æ¨¡å—å•ç‹¬æ‹†å‡ºæ¥\n\n#### 8.4.3 `optimization.splitChunks`æ‹†åˆ†æ¨¡å—\n\n> è¿™é‡Œæ˜¯ webpack4\n\n```javascript\n// vue.config.js\nmodule.exports = {\n  chainWebpack: (config) => {\n    config.optimization.splitChunks({\n      chunks: \"all\", // å¿…é¡»ä¸‰é€‰ä¸€ï¼š \"initial\"(åŒæ­¥åŒ…) | \"all\"(æ¨èï¼ŒåŒæ­¥æˆ–å¼‚æ­¥åŒ…) | \"async\" (é»˜è®¤å°±æ˜¯asyncï¼Œå¼‚æ­¥åŒ…)\n      automaticNameDelimiter: \"~\", // æ‰“åŒ…åˆ†éš”ç¬¦\n      name: function (module, chunks, cacheGroupKey) {\n        const moduleFileName = module\n          .identifier()\n          .split(\"/\")\n          .reduceRight((item) => item);\n        const allChunksNames = chunks.map((item) => item.name).join(\"~\");\n        return `${moduleFileName}`;\n      },\n      cacheGroups: {\n        vendors: {\n          name: \"chunk-vendors\",\n          chunks: \"initial\",\n          reuseExistingChunk: true,\n          enforce: true, // é‡åˆ°é‡å¤åŒ…ç›´æ¥å¼•ç”¨ï¼Œä¸é‡æ–°æ‰“åŒ…\n          priority: 0, // æ‰“åŒ…ä¼˜å…ˆçº§æƒé‡å€¼\n          // minChunks: 1,  // å¼•ç”¨è¶…è¿‡ä¸€æ¬¡ç›´æ¥æ‰“åŒ…åˆ°chunkä¸­\n          minSize: 30000,\n        },\n        pages: {\n          name: \"chunk-pages\",\n          test: /pages\\.json$/,\n          chunks: \"all\",\n          reuseExistingChunk: true,\n          enforce: true,\n          priority: 90,\n          minChunks: 1,\n          minSize: 10000,\n        },\n        \"node-rsa\": {\n          name: \"chunk-node-rsa\",\n          test: /node-rsa/,\n          chunks: \"all\",\n          reuseExistingChunk: true,\n          enforce: true,\n          priority: 70,\n        },\n        buffer: {\n          name: \"chunk-buffer\",\n          test: /buffer|is-buffer/,\n          chunks: \"all\",\n          reuseExistingChunk: true,\n          priority: 90,\n          minChunks: 1,\n          minSize: 15000,\n          enforce: true,\n        },\n        \"core-js\": {\n          name: \"chunk-core-js\",\n          test: /core-js/,\n          chunks: \"initial\",\n          reuseExistingChunk: true,\n          enforce: true,\n          priority: 70,\n        },\n        \"uni-h5\": {\n          name: \"chunk-uni-h5\",\n          test: /uni-h5/,\n          chunks: \"initial\",\n          reuseExistingChunk: true,\n          enforce: true,\n          priority: 80,\n        },\n        vue: {\n          name: \"chunk-vue\",\n          test: /vue-cli-plugin-uni/,\n          chunks: \"initial\",\n          reuseExistingChunk: true,\n          enforce: true,\n          priority: 85,\n        },\n        bn: {\n          name: \"chunk-bn\",\n          test: /bn/,\n          chunks: \"initial\",\n          reuseExistingChunk: true,\n          enforce: true,\n          priority: 70,\n        },\n      },\n    });\n\n    // æå–å…¬å…±çš„runtime\n    config.optimization.runtimeChunk(\"single\");\n  },\n};\n```\n\n#### 8.4.4 æ‹†åˆ†çš„ chunk æ²¡æœ‰åœ¨`index.html`ä¸­è‡ªåŠ¨å¼•å…¥\n\n> æ‰“åŒ…å¾ˆæˆåŠŸï¼Œæ²¡ä»»ä½•æŠ¥é”™ï¼Œä½†æ˜¯åœ¨è¿è¡Œé¡¹ç›®çš„æ—¶å€™ï¼Œé¡µé¢ä¸€ç‰‡ç©ºç™½ï¼Œæ²¡ä»»ä½• ui å±•ç¤ºã€‚**é—®é¢˜å°±å‡ºåœ¨ï¼Œæ‹†åˆ†å‡ºæ¥çš„å„ä¸ªå° chunkï¼Œæ²¡æœ‰è‡ªåŠ¨åœ¨ index.html ä¸­å¼•å…¥**ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ‰“åŒ…å‡ºæ¥çš„ unpackage ç›®å½•ï¼Œæœ¬åœ°å¯åŠ¨ä¸€ä¸ªé™æ€æœåŠ¡ï¼ŒæŠŠé‚£äº› chunk æ‰‹åŠ¨å¼•å…¥ï¼Œåˆ·æ–°é¡µé¢ï¼Œé¡µé¢ ui æ˜¾ç¤ºå‡ºæ¥äº†\n\n**æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾åˆ°[html-webpack-plugin](https://www.npmjs.com/package/html-webpack-plugin)çš„é…ç½®ï¼ŒæŠŠæˆ‘ä»¬å•ç‹¬æ‹†åˆ†å‡ºæ¥çš„ chunkï¼Œæ·»åŠ åˆ°`chunks`é…ç½®ä¸­**\n\n```javascript\n// vue.config.js\nfunction changeHtmlWebpackPluginChunks(config) {\n  const plugins = config.plugins;\n  const chunkArr = [\n    \"runtime\",\n    \"chunk-vue\",\n    \"chunk-uni-h5\",\n    \"chunk-core-js\",\n    \"chunk-node-rsa\",\n    \"chunk-buffer\",\n    \"chunk-bn\",\n    \"chunk-pages\",\n  ];\n\n  plugins.forEach((item, index) => {\n    // ä¸ºHtmlWebpackPlugin\n    if (\n      item.options &&\n      Object.prototype.toString.call(item.options) === \"[object Object]\" &&\n      Object.hasOwnProperty.call(item.options, \"filename\") &&\n      Object.hasOwnProperty.call(item.options, \"chunks\") &&\n      item.options.filename === \"index.html\"\n    ) {\n      const oldChunks = item.options.chunks || [];\n      // ä¿®æ”¹chunkså¼•å…¥\n      item.options.chunks = [...chunkArr, ...oldChunks];\n    }\n  });\n}\n\nmodule.exports = {\n  configureWebpack: (config) => {\n    if (process.env.NODE_ENV === \"production\") {\n      changeHtmlWebpackPluginChunks(config);\n    }\n  },\n};\n```\n\nä¸‹å›¾æ˜¯æ‹†åˆ†å chunk-vendorsï¼Œå’Œä¹‹å‰å¯¹æ¯”ï¼Œé‚£äº›å¤§æ¨¡å—éƒ½è¢«æ‹†åˆ†å‡ºå»äº†ï¼Œæ–‡ä»¶ä½“ç§¯ä¹Ÿä» 1M å¤šå˜æˆäº† 320kbï¼Œé¦–é¡µåŠ è½½ä¹Ÿä» 10s å¤šå˜æˆäº† 3s å·¦å³ã€‚\n\n![ ](../img/uniapp/new-chunk-vendors.png)\n\n#### 8.4.5 å…³äºæ‹†åˆ† vendors åï¼Œ`uview-ui`éƒ¨åˆ†ç»„ä»¶æŠ¥é”™\n\n> é¡¹ç›®ä¸­ä½¿ç”¨åˆ°äº†`uview-ui`ui æ¡†æ¶\n\né‡æ–°æ‰“åŒ…ï¼Œæœ¬åœ°å†æ¬¡å¯åŠ¨é¡¹ç›®ï¼Œæµè§ˆå™¨æ§åˆ¶å°å‘ç°å¦‚ä¸‹æŠ¥é”™\n\n![ ](../img/uniapp/console.png)\n\nå†åˆ° unpackage ç›®å½•ä¸€çœ‹ï¼Œå±…ç„¶è¿˜æœ‰`u-icon.vue`å’Œ`u-line.vue`æœªæ‰“åŒ…ï¼\n\né‚£å•ç‹¬æå–è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸º chunk è¿›è¡Œæ‰“åŒ…ï¼Œå†æ¬¡æ‰“åŒ…åå¯åŠ¨é¡¹ç›®ï¼Œè¿™ä¸¤ä¸ªç»„ä»¶æ²¡æŠ¥é”™ï¼Œå…¶ä»–ç»„ä»¶æŠ¥é”™äº†ï¼Œunpackage ç›®å½•é‡Œå‡ºç°äº†æ›´å¤šçš„\"u-xx.vue\"ç»„ä»¶ï¼Œè¿™æ˜¯ä»€ä¹ˆæƒ…å†µï¼Ÿ\n\nçŒœæµ‹æ˜¯å¼•å…¥ uview-ui æ¡†æ¶æ—¶çš„[easycom ç»„ä»¶æ¨¡å¼](https://v1.uviewui.com/components/npmSetting.html)æƒ¹å¾—é¬¼ï¼Œæˆ‘å°è¯•ç€åœ¨ easycom é‡Œæ·»åŠ è‡ªå®šä¹‰`custom`é…ç½®ï¼ŒæŠŠè¿™ä¸¤ä¸ªç»„ä»¶å†™åœ¨é‡Œé¢ï¼Œä½†æ˜¯ä¸ç®¡ç”¨ã€‚é¡µé¢ä¸æŠ¥é”™ï¼Œä½†æ˜¯æ ·å¼å‡ºé—®é¢˜äº†ã€‚ã€‚ã€‚\n\næˆ–è€…ç›´æ¥åˆ é™¤ easycom é…ç½®è¿›è¡Œï¼Œå¯åŠ¨é¡¹ç›®ï¼Œé¡µé¢æ ·å¼å‡ºé—®é¢˜äº†ã€‚ã€‚ã€‚\n\næœ€ç»ˆè¿˜æ˜¯åœ¨`splitChunks`é‡Œå•ç‹¬æå– uview-ui ä¸º chunkï¼Œè¿™æ ·é—®é¢˜æ˜¯è§£å†³äº†ï¼Œä½†æ˜¯è¿™æ ·åœ¨å…¥å£çš„æ—¶å€™ï¼Œå°±è¦åŠ è½½ä¸€ä¸ªæå–å‡ºæ¥çš„ uview-ui(é¡¹ç›®ä¸­ä½¿ç”¨åˆ°çš„æ‰€æœ‰ uview-ui ç»„ä»¶ï¼Œå¹¶éæ•´ä¸ª uview-ui)ã€‚æœªæ‹†åˆ†å‰ï¼Œæ¯ä¸ªé¡µé¢åªéœ€åŠ è½½è‡ªå·±æ‰€éœ€çš„ç»„ä»¶ï¼Œç°åœ¨æŠŠæ‰€æœ‰é¡µé¢çš„ç»„ä»¶éƒ½æå–å‡ºæ¥äº†ï¼Œç­‰äºæ˜¯æ¯ä¸ªé¡µé¢éƒ½åŠ è½½äº†å†—ä½™çš„ uview-ui ç»„ä»¶ã€‚å¥½åœ¨æ˜¯æœ€ç»ˆé¡µé¢åŠ è½½é€Ÿåº¦æ˜¯æ¯”ä¹‹å‰å¿«äº†ã€‚\n\nè¿™é‡Œæœ‰çŸ¥é“æ€ä¹ˆå¤„ç†çš„ï¼Œæˆ–è€…æœ‰é‡åˆ°ç›¸åŒé—®é¢˜çš„ï¼Œåˆ†äº«ä¸‹æ€ä¹ˆå¤„ç†ã€‚\n\n#### 8.4.6 æ‹†åˆ†ä¸ºå„ä¸ªå° chunk åï¼Œé¡µé¢ js è¯·æ±‚å˜å¤šäº†\n\n![ ](../img/uniapp/new-console.png)\n\né¡µé¢ js è¯·æ±‚å˜å¤šï¼Œå¯¹é¡µé¢æ€§èƒ½ä¹Ÿæœ‰ä¸€å®šå½±å“ï¼Œæ‰€ä»¥è¿™é‡Œæ‹†åˆ†ï¼Œè§†å…·ä½“é¡¹ç›®è€Œå®šã€‚\n\n## 9. hbuilderx åˆ›å»ºçš„é¡¹ç›®,h5 æŒç»­éƒ¨ç½²\n\n> è¿™é‡Œè§†å…¬å¸å†…éƒ¨æƒ…å†µè€Œå®šï¼Œæˆ‘è¿™æ˜¯æœåŠ¡å™¨ä¸Šæœ‰ç°æˆçš„ nginx,ä¹Ÿæ— éœ€è‡ªå·±æ‰“åŒ… docker é•œåƒ\n\n1. `.gitlab.yml`\n\n> SSH_USERNAME,SSH_HOST,SSH_PASSWORD è¿™ 3 ä¸ªå˜é‡å†™åœ¨é¡¹ç›®`Setting->CI/CD->Variables`é‡Œ\n\n```yml\nstages:\n  - build\n\njob_build:\n  stage: build\n  script:\n    # - sudo docker image build -t demo_h5 .\n    # - sudo docker tag demo_h5 registry.cn-hangzhou.aliyuncs.com/test-blog/demo_h5:latest\n    # - sudo docker login --username=$ALIYUN_DOCKER_NAME registry.cn-hangzhou.aliyuncs.com --password=$ALIYUN_DOCKER_PASSWORD\n    # - sudo docker push registry.cn-hangzhou.aliyuncs.com/test-blog/demo_h5:latest\n    # - sudo docker logout\n    - if yum list installed | grep 'sshpass'; then echo yes; else yum -y install sshpass;fi\n    - sh deploy.sh $SSH_USERNAME $SSH_HOST $SSH_PASSWORD\n  tags:\n    # å…¬å¸å†…éƒ¨gitlabæ³¨å†Œä¸€ä¸ªrunner,æˆ–è€…å†™ä¸€ä¸ªå…¬å…±runner\n    - xxxx\n  only:\n    - main\n```\n\n2. `deploy.sh`\n\n> å°†æ‰“åŒ…å‡ºæ¥çš„æ–‡ä»¶ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨æŒ‡å®šç›®å½•ï¼Œç„¶åé¡µé¢å°±å¯ä»¥è®¿é—®äº†\n>\n> ä¸ºä»€ä¹ˆè¦å°†æ‰“åŒ…å‡ºæ¥çš„ä»£ç è¿›è¡Œå‹ç¼©ï¼Œå› ä¸ºæ‰“åŒ…å‡ºæ¥çš„æ–‡ä»¶æ•°é‡å¾ˆå¤šï¼Œå¦‚æœä¸€ä¸ªä¸ªä¼ è¾“ï¼Œä¼šéå¸¸æ…¢ï¼Œæ‰€ä»¥è¦è¿›è¡Œå‹ç¼©åå˜æˆ 1 ä¸ªæ–‡ä»¶è¿›è¡Œä¼ è¾“\n\n```sh\n#!/bin/bash\n\necho \"ssh deploy start==>\"\n# echo \"$3\" ssh \"$1\"@\"$2\" --password-stdin\n\nusername=$1\nhost=$2\npassword=$3\n# æ‰“åŒ…ç›®å½•\ndir=\"./unpackage/dist/build/h5\"\n# æœåŠ¡å™¨ç›®å½•\ntarget=\"/home/demo_h5/nginx/html/app-web\"\n\n# ä¸Šä¼ æœ¬åœ°æ–‡ä»¶åˆ°æœåŠ¡å™¨\n# scp /path/filename username@servername:/path\n# ä¸Šä¼ ç›®å½•åˆ°æœåŠ¡å™¨\n# scp -r local_dir username@servername:remote_dir\n\n# sshpass -p ${password} scp ${dir}/index.html ${username}@${host}:/home/demo_h5/nginx/html/app-web\n# sshpass -p ${password} scp -r ${dir}/static ${username}@${host}:/home/demo_h5/nginx/html/app-web\n\n# cdåˆ°æŒ‡å®šç›®å½•\ncd ${dir}\n# å‹ç¼©æ‰€æœ‰æ–‡ä»¶å¹¶é‡å‘½å\nzip -r -q -o build.zip ./\n# é€šè¿‡sshpassä¸Šä¼ å‹ç¼©æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•\nsshpass -p ${password} scp ./build.zip ${username}@${host}:${target}\nsleep 2\n\n# ç™»å½•è¿œç¨‹æœåŠ¡å™¨\n# cd åˆ°æŒ‡å®šç›®å½•\n# unzip è§£å‹åˆ°æŒ‡å®šç›®å½•\n#   -o ä¸å¿…å…ˆè¯¢é—®ç”¨æˆ·ï¼Œunzipæ‰§è¡Œåè¦†ç›–åŸæœ‰æ–‡ä»¶ã€‚\n#   -d è§£å‹åˆ°æŒ‡å®šç›®å½•\n# åˆ é™¤å‹ç¼©æ–‡ä»¶\n\nsshpass -p ${password} ssh ${username}@${host} \"cd /home/demo_h5/nginx/html/app-web && pwd && unzip -o -q ./build.zip -d ./ && rm -rf ./build.zip\"\n\necho \"ssh deploy end==>\"\n```\n\n3. git æäº¤ä»£ç \n\nä¸å‡ºæ„å¤–ï¼Œä»£ç è‡ªåŠ¨éƒ¨ç½²åˆ°ç›¸åº”ä½ç½®ï¼Œæµè§ˆå™¨å¯ä»¥è®¿é—®äº†\n\n```log\n$ if yum list installed | grep 'sshpass'; then echo yes; else yum -y install sshpass;fi\nRepository base is listed more than once in the configuration\nRepository updates is listed more than once in the configuration\nRepository extras is listed more than once in the configuration\nRepository centosplus is listed more than once in the configuration\nRepodata is over 2 weeks old. Install yum-cron? Or run: yum makecache fast\nsshpass.x86_64                              1.06-2.el7                 @extras\nyes\n$ sh deploy.sh $SSH_USERNAME $SSH_HOST $SSH_PASSWORD\nssh deploy start==>\n/home/demo_h5/nginx/html/app-web\nssh deploy end==>\nJob succeeded\n```\n\n## 10. å‚è€ƒèµ„æ–™\n\n1. [uniapp å®˜æ–¹æ–‡æ¡£](https://uniapp.dcloud.net.cn/)\n2. [webpack4 å®˜æ–¹æ–‡æ¡£](https://v4.webpack.docschina.org/concepts/)\n3. [vue-cli å®˜æ–¹æ–‡æ¡£](https://cli.vuejs.org/zh/guide/)\n"},{"id":"HhcL4KPgeGCOqvUazMOBI","title":"Taroä¸å¾®ä¿¡å°ç¨‹åºåŸç”Ÿç»„ä»¶ä¹‹é—´çš„äº‹ä»¶é€šä¿¡","keywords":["taro"," wemark"],"date":"2022-04-04 18:02:42","fileName":"taro-wemark","content":"\n- [å°ç¨‹åºåšå®¢ github ä»“åº“](https://github.com/sRect/wechat-blog)\n\n- [æœ¬å°ç¨‹åºé“¾æ¥](#å°ç¨‹åº://sRectçš„ä¸ªäººåšå®¢/sRectçš„ä¸ªäººåšå®¢/Z1MPSUtT7bnfPFd)\n\n## 1. éœ€æ±‚èƒŒæ™¯\n\næœ€è¿‘åœ¨åšä¸€ä¸ªå¾®ä¿¡å°ç¨‹åºç‰ˆçš„ç®€æ˜“åšå®¢ï¼ŒåŸæœ¬æ˜¯å‡†å¤‡è‡ªå·±è§£æ`markdown`å¹¶æ¸²æŸ“ï¼Œæœ€åè¿˜æ˜¯ä½¿ç”¨äº†[`wemark`](https://github.com/TooBug/wemark)ç¬¬ä¸‰æ–¹ç»„ä»¶æ¥æ¸²æŸ“ï¼Œå› ä¸ºè‡ªå·±è§£ææ¸²æŸ“çš„å¾ˆéš¾çœ‹ã€‚\n\nå› ä¸ºå°ç¨‹åºå†…æ‰“å¼€ç¬¬ä¸‰æ–¹é“¾æ¥ï¼Œéœ€è¦åœ¨é¡¹ç›®é…ç½®é‡Œè®¾ç½®åŸŸåæ‰èƒ½æ‰“å¼€ï¼Œå¯¹äºç¬¬ä¸‰æ–¹ç½‘ç«™é“¾æ¥å¾ˆæ— å¥ˆï¼Œæ‰€ä»¥å¹²è„†ç›´æ¥è¿›è¡Œå¤åˆ¶ï¼Œç„¶åå¯ä»¥è‡ªè¡Œé€šè¿‡æµè§ˆå™¨æ‰“å¼€ã€‚\n\n```javascript\nconst Detail = () => {\n  const mdStr = `...`;\n\n  return (\n    <View id=\"md\" className=\"markdown-body\">\n      <wemark id=\"wemark\" md={mdStr} link highlight type=\"wemark\" />\n    </View>\n  );\n};\n```\n\n![ ](../img/taro-wemark/link.png)\n\nå¦‚ä¸Šå›¾æ˜¾ç¤ºï¼Œå°±æ˜¯æƒ³åœ¨ç‚¹å‡»çš„æ—¶å€™ï¼Œæ‹¿åˆ°é“¾æ¥é‡Œçš„ urlã€‚\n\nå…¶å®ç†Ÿæ‚‰å¾®ä¿¡å°ç¨‹åºçš„å¼€å‘ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„éœ€æ±‚ï¼Œä½†æˆ‘ç­‰å½©ç¬”ä¸ç†Ÿæ‚‰ã€‚ğŸ˜„\n\nåŸæœ¬è¿˜æƒ³æ‹¿åˆ° domï¼Œç„¶åè‡ªå·±ç»‘å®šäº‹ä»¶ï¼Œæœ€åå‘ç°è¿™æ ·é”™çš„ç¦»è°±ã€‚\n\n## 2. å½©ç¬”çš„é”™è¯¯ä¹‹è·¯\n\n> **æ³¨æ„**ï¼š ä»¥ä¸‹å‡ ç§æ–¹å¼éƒ½æ²¡æˆåŠŸ\n\n### 2.1 ä½¿ç”¨`createSelectorQuery`api\n\n> æ‰“å°å‡ºæ¥ï¼Œéƒ½æ²¡æœ‰æƒ³è¦çš„ç»“æœï¼Œæ²¡æ³•ç»§ç»­ä¸‹å»\n\n```javascript\nimport Taro, { useReady } from \"@tarojs/taro\";\n\nconst Detail = () => {\n  useReady(() => {\n    Taro.createSelectorQuery()\n      .select(\"#md\")\n      .node((res) => {\n        console.log(\"==>\");\n        console.log(res);\n      })\n      .exec();\n  });\n};\n```\n\næˆ–è€…\n\n```javascript\nuseReady(() => {\n  const query = Taro.createSelectorQuery().in(this);\n\n  query\n    .select(\"#md\")\n    .node(function (res) {\n      console.log(res.node);\n    })\n    .exec();\n});\n```\n\n### 2.2 ä½¿ç”¨`getCurrentInstance`api\n\n> æ‰“å°å‡ºæ¥ï¼Œä¹Ÿæ²¡æœ‰æƒ³è¦çš„ï¼Œæ— æ³•ç»§ç»­ä¸‹å»\n\n```javascript\nimport { getCurrentInstance } from \"@tarojs/taro\";\n\nconst { page } = getCurrentInstance();\nconst md = page.selectComponent(\"#md\");\n\nconsole.log(md);\n```\n\n### 2.3 ç›´æ¥åœ¨æœ€å¤–é¢ç»‘å®šäº‹ä»¶\n\n> æ‰“å°å‡ºæ¥ï¼Œæ— æ³•åŒºåˆ†æ˜¯å¦ç‚¹å‡»åœ¨é“¾æ¥ä¸Šï¼Œä¹Ÿæ— æ³•ç»§ç»­ä¸‹å»\n\n```javascript\nconst Detail = () => {\n  const mdStr = `...`;\n\n  useEffect(() => {\n    const el = document.getElementById(\"md\");\n    function handleClick(event) {\n      console.log(event);\n    }\n    el.addEventListener(\"tap\", handleClick);\n\n    return () => {\n      el.removeEventListener(\"tap\", handleClick);\n    };\n  }, []);\n\n  return (\n    <View id=\"md\" className=\"markdown-body\">\n      <wemark id=\"wemark\" md={mdStr} link highlight type=\"wemark\" />\n    </View>\n  );\n};\n```\n\n## 3. è§£å†³\n\n> è¿˜æ˜¯å¾—åˆ°`wemark`ç»„ä»¶é‡Œå»ä¿®æ”¹\n\n- `wemark/wemark.js`æ·»åŠ å¦‚ä¸‹ä»£ç \n\n```javascript\nComponent({\n  methods: {\n    onTap: function (e) {\n      console.log(\"onTap==>\", e);\n      this.triggerEvent(\"myevent\", e);\n    },\n  },\n});\n```\n\n- `wemark/wemark.wxml`ä¸­æ·»åŠ `data-url`å’Œæ·»åŠ äº‹ä»¶ç»‘å®š\n\n```html\n<navigator\n  class=\"wemark_inline_link\"\n  url=\"{{renderInline.data.href}}\"\n  wx:if=\"{{renderInline.type === 'link'}}\"\n  data-url=\"{{renderInline.data.href}}\"\n  bindtap=\"onTap\"\n>\n  {{renderInline.content}}\n</navigator>\n```\n\n- å›åˆ°è‡ªå·±ä»£ç ä¸­ä¿®æ”¹\n\n```javascript\nconst Detail = () => {\n  const mdStr = `...`;\n\n  // é“¾æ¥å¤åˆ¶\n  const onMyEvent = (e) => {\n    console.log(e);\n\n    const str = e?.detail?.currentTarget?.dataset?.url;\n\n    if (!str) return;\n\n    Taro.setClipboardData({\n      data: str,\n      success() {\n        Taro.showToast({\n          title: \"é“¾æ¥å¤åˆ¶æˆåŠŸ\",\n          icon: \"success\",\n        });\n      },\n    });\n  };\n\n  return (\n    <View id=\"md\" className=\"markdown-body\">\n      <wemark\n        id=\"wemark\"\n        md={mdStr}\n        link\n        highlight\n        type=\"wemark\"\n        onMyevent={onMyevent}\n      />\n    </View>\n  );\n};\n```\n\n![ ](../img/taro-wemark/dataset.png)\n\n- è‡³æ­¤ï¼Œè§£å†³äº†è¿™ä¸ªå°éœ€æ±‚\n\n## 4. å‚è€ƒé“¾æ¥\n\n1. [ç»„ä»¶é—´é€šä¿¡ä¸äº‹ä»¶](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/events.html)\n\n2. [åŸç”Ÿé¡¹ç›®ä½¿ç”¨ Taro](https://taro-docs.jd.com/taro/docs/taro-in-miniapp/#%E7%BB%84%E4%BB%B6%E9%97%B4%E9%80%9A%E4%BF%A1%E4%B8%8E%E4%BA%8B%E4%BB%B6)\n"},{"id":"dHg5T1zS3Ur0q-4FueL9k","title":"mermaidä½¿ç”¨","keywords":["mermaid"],"date":"2022-3-11 16:28:48","fileName":"mermaid","content":"\nmermaid æµç¨‹å›¾ + é¥¼å›¾ä½¿ç”¨\n\n# img\n\n![img](../img/mermaid/test5.png)\n\n## table\n\n| å·¦å¯¹é½ | å³å¯¹é½ | å±…ä¸­å¯¹é½ |\n| :----- | -----: | :------: |\n| å•å…ƒæ ¼ | å•å…ƒæ ¼ |  å•å…ƒæ ¼  |\n| å•å…ƒæ ¼ | å•å…ƒæ ¼ |  å•å…ƒæ ¼  |\n\n## æµç¨‹å›¾\n\n```mermaid\nflowchart TB\nA[Hard] -->|Text| B(Round)\nB --> C{Decision}\nC -->|One| D[Result 1]\nC -->|Two| E(Result 2)\n```\n\n## é¥¼å›¾\n\n> https://mermaid-js.github.io/mermaid/#/pie\n\n```mermaid\npie\ntitle Pets adopted by volunteers\n\"Dogs\" : 386\n\"Cats\" : 85\n\"Rats\" : 15\n```\n\n## å‚è€ƒ\n\n1. [mermaid](https://github.com/mermaid-js/mermaid/blob/develop/README.zh-CN.md)\n"},{"id":"w9sIDIftjljEsu0qEmz9-","title":"å¾®ä¿¡å°ç¨‹åºæŒç»­è·å–å®šä½æµ‹è¯•","keywords":["å¾®ä¿¡å°ç¨‹åº"," Tarojs"],"date":"2021-11-03","fileName":"location","content":"\n- [github æºç ä»“åº“](https://github.com/sRect/taro_wx)\n\n### 1. å®¢æˆ·ç«¯è¯¦æƒ…\n\n> æ–‡ç« å†…ä½¿ç”¨ Tarojs å¼€å‘å¾®ä¿¡å°ç¨‹åº\n\n- æ‰‹æœºå‹å·ï¼šå°ç±³ 10\n- æ“ä½œç³»ç»ŸåŠç‰ˆæœ¬ï¼šAndroid 10\n- å®¢æˆ·ç«¯å¹³å°ï¼šandroid\n- SDKVersionï¼š2.20.2\n\n### 2. æ³¨æ„ç‚¹\n\n1. taro é¡¹ç›®é…ç½®æ–‡ä»¶`src/app.config.js`ä¸­è¦æ·»åŠ ä»¥ä¸‹é…ç½®\n\n```javascript\nexport default {\n  requiredBackgroundModes: [\"location\"],\n  permission: {\n    \"scope.userLocation\": {\n      desc: \"å¦‚å®å¡«å†™å®é™…ç”¨é€”\", // é«˜é€Ÿå…¬è·¯è¡Œé©¶æŒç»­åå°å®šä½\n    },\n  },\n};\n```\n\n2. æ£€æŸ¥æ‰‹æœºæ˜¯å¦æ‰“å¼€ä½ç½®ä¿¡æ¯å¼€å…³\n\n```javascript\nTaro.getSystemInfoAsync({\n  success(data) {\n    console.log(data.locationEnabled);\n  },\n});\n```\n\n3. æ£€æŸ¥æ˜¯å¦ç»™å¾®ä¿¡å¼€äº†å®šä½æƒé™\n\n```javascript\nTaro.getSystemInfoAsync({\n  success(data) {\n    console.log(data.locationAuthorized);\n  },\n});\n```\n\n4. æ£€æŸ¥å½“å‰å°ç¨‹åºæ˜¯å¦å¼€äº†åå°å®šä½æƒé™\n\n```javascript\nTaro.getSetting({\n  success(res) {\n    const authSetting = res.authSetting;\n    if (\n      !authSetting[\"scope.userLocation\"] ||\n      !authSetting[\"scope.userLocationBackground\"]\n    ) {\n      // è®©ç”¨æˆ·åœ¨å¼¹å‡ºçš„é€‰é¡¹ä¸­åŠ¡å¿…å‹¾é€‰â€œä½¿ç”¨å°ç¨‹åºæœŸé—´å’Œç¦»å¼€å°ç¨‹åºä¹‹åâ€é€‰é¡¹\n      Taro.openSetting();\n    }\n  },\n});\n```\n\n### 3. å®Œæ•´ä»£ç \n\n```jsx\nimport React, { useState } from \"react\";\nimport Taro, { useReady, useDidShow, useDidHide } from \"@tarojs/taro\";\nimport { View, Map } from \"@tarojs/components\";\n\nconst hasOwnProperty = (obj, key) => {\n  return Object.prototype.hasOwnProperty.call(obj, key);\n};\n\nconst HandleLocation = () => {\n  const [systemSetting, setSystemSetting] = useState({});\n  const [location, setLocation] = useState({ longitude: \"\", latitude: \"\" });\n  const [locationList, setLocationList] = useState([]);\n\n  const handleGetLocation = () => {\n    if (Taro.canIUse(\"startLocationUpdateBackground\")) {\n      // https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/authorize.html\n      // å°ç¨‹åºå…¨å±€é…ç½®\n      // https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/app.html#permission\n      // wx.authorize({scope: \"scope.userInfo\"})ï¼Œä¸ä¼šå¼¹å‡ºæˆæƒçª—å£ï¼Œè¯·ä½¿ç”¨ <button open-type=\"getUserInfo\"/>\n      // éœ€è¦æˆæƒ scope.userLocationã€scope.userLocationBackground æ—¶å¿…é¡»é…ç½®åœ°ç†ä½ç½®ç”¨é€”è¯´æ˜\n\n      Taro.startLocationUpdateBackground({\n        success() {\n          Taro.onLocationChange((data) => {\n            setLocationList((pre) => [...pre, data]);\n\n            setLocation({ longitude: data.longitude, latitude: data.latitude });\n\n            // ajaxå‘é€æ•°æ®åˆ°åå°\n            // ...\n          });\n        },\n        fail(err) {\n          console.log(err);\n          Taro.showToast({\n            icon: \"error\",\n            title: \"å®šä½å¤±è´¥\",\n          });\n\n          Taro.openSetting();\n        },\n      });\n    } else {\n      Taro.showToast({\n        icon: \"error\",\n        title: \"æ‚¨çš„è®¾å¤‡æš‚ä¸æ”¯æŒå®šä½\",\n      });\n    }\n  };\n\n  // æ£€æŸ¥æ‰‹æœºæ˜¯å¦æ‰“å¼€ä½ç½®ä¿¡æ¯å¼€å…³\n  // æ£€æŸ¥æ˜¯å¦ç»™å¾®ä¿¡å¼€äº†å®šä½æƒé™\n  const checkMobileLocationAuth = () => {\n    return new Promise((resolve, reject) => {\n      Taro.getSystemInfoAsync({\n        success(data) {\n          setSystemSetting(data);\n\n          if (\n            data &&\n            hasOwnProperty(data, \"locationEnabled\") &&\n            !data.locationEnabled\n          ) {\n            Taro.showModal({\n              title: \"æç¤º\",\n              content: \"è¯·æ‰“å¼€æ‰‹æœºè®¾ç½®-ä½ç½®ä¿¡æ¯(GPS)å¼€å…³\",\n              confirmText: \"ç¡®å®š\",\n              showCancel: false,\n            });\n\n            reject();\n          }\n\n          if (\n            data &&\n            hasOwnProperty(data, \"locationAuthorized\") &&\n            !data.locationAuthorized\n          ) {\n            Taro.showModal({\n              title: \"æç¤º\",\n              content:\n                \"è¯·æ‰“å¼€æ‰‹æœºè®¾ç½®-åº”ç”¨è®¾ç½®-åº”ç”¨ç®¡ç†-å¾®ä¿¡-æƒé™ç®¡ç†-å®šä½æƒé™å¼€å…³\",\n              confirmText: \"ç¡®å®š\",\n              showCancel: false,\n              success() {\n                // Taro.openSetting();\n              },\n            });\n\n            reject();\n          }\n\n          resolve();\n        },\n        fail() {\n          reject();\n        },\n      });\n    });\n  };\n\n  // æ£€æŸ¥å½“å‰å°ç¨‹åºæ˜¯å¦å¼€äº†å®šä½æƒé™\n  const checkMiniAppLocationAuth = () => {\n    return new Promise((resolve, reject) => {\n      if (!Taro.canIUse(\"getSetting\")) return reject();\n\n      Taro.getSetting({\n        success: function (res) {\n          const authSetting = res.authSetting;\n\n          if (\n            authSetting &&\n            hasOwnProperty(authSetting, \"scope.userLocation\") &&\n            hasOwnProperty(authSetting, \"scope.userLocationBackground\") &&\n            authSetting[\"scope.userLocation\"] &&\n            authSetting[\"scope.userLocationBackground\"]\n          ) {\n            resolve();\n          } else {\n            if (Taro.canIUse(\"openSetting\")) {\n              Taro.showModal({\n                title: \"æç¤º\",\n                content:\n                  \"è¯·åœ¨ç‚¹å‡»ç¡®å®šåï¼Œåœ¨å¼¹å‡ºçš„é€‰é¡¹ä¸­åŠ¡å¿…å‹¾é€‰â€œä½¿ç”¨å°ç¨‹åºæœŸé—´å’Œç¦»å¼€å°ç¨‹åºä¹‹åâ€é€‰é¡¹\",\n                confirmText: \"ç¡®å®š\",\n                showCancel: false,\n                success() {\n                  Taro.openSetting();\n                },\n              });\n            } else {\n              Taro.showModal({\n                title: \"æç¤º\",\n                content:\n                  \"è¯·ç‚¹å‡»å³ä¸Šè§’â€œ...â€æ›´å¤š-è®¾ç½®-ä½ç½®ä¿¡æ¯ï¼Œåœ¨å¼¹å‡ºçš„é€‰é¡¹ä¸­åŠ¡å¿…å‹¾é€‰â€œä½¿ç”¨å°ç¨‹åºæœŸé—´å’Œç¦»å¼€å°ç¨‹åºä¹‹åâ€é€‰é¡¹\",\n                confirmText: \"ç¡®å®š\",\n                showCancel: false,\n              });\n            }\n\n            reject();\n          }\n        },\n      });\n    });\n  };\n\n  useReady(() => {\n    console.log(\"useReady==>\");\n  });\n\n  useDidShow(() => {\n    console.log(\"useDidShow==>\");\n    if (Taro.canIUse(\"stopLocationUpdate\")) {\n      Taro.stopLocationUpdate({\n        complete() {\n          checkMobileLocationAuth()\n            .then(checkMiniAppLocationAuth)\n            .then(() => {\n              // å…¨éƒ¨okï¼Œå¯ä»¥è¿›è¡ŒæŒç»­å®šä½\n              handleGetLocation();\n            })\n            .catch(() => {\n              console.log(\"err==>\");\n            });\n        },\n      });\n    }\n  });\n\n  useDidHide(() => {\n    console.log(\"useDidHide==>\");\n  });\n\n  return (\n    <View>\n      <Map\n        style=\"width: 100%; height: 200px;\"\n        scale={16}\n        longitude={location.longitude}\n        latitude={location.latitude}\n      />\n    </View>\n  );\n};\n```\n\n### 4. æ€»ç»“\n\n- ç»è¿‡æœ¬åœ°å¼€å‘å®é™…æµ‹è¯•ï¼ŒæŠŠå°ç¨‹åºåˆ‡åˆ°åå°åï¼Œåˆ‡æ¢åˆ°å…¶ä»– app\n- æˆ–è€…æ‰‹æœºç›´æ¥é”å±\n\nä»¥ä¸Šä¸¤ç§æƒ…å†µï¼Œ1 åˆ†é’Ÿåï¼Œ`startLocationUpdateBackground`api å³å¤±æ•ˆï¼Œåªæœ‰é‡æ–°è§£é”æ‰‹æœºï¼Œé‡æ–°å›åˆ°å¾®ä¿¡ï¼Œapi çš„å®æ—¶ä½ç½®ç›‘æ§æ‰è¢«å”¤é†’ï¼Œå°šæœªæ‰¾åˆ°è§£å†³æ–¹æ³•\n\n### 5. å…¶ä»–\n\né’‰é’‰å°ç¨‹åº`dd.getLocation`åªæœ‰å½“å‰é’‰é’‰å°ç¨‹åºå½“å‰åœ¨æ¿€æ´»çŠ¶æ€ä¸‹å¯ä»¥è·å–åˆ°ï¼Œåˆ‡æ¢åˆ°åå°å’Œæ‰‹æœºé”å±åï¼Œå³å¤±æ•ˆ\n\n### 6. å‚è€ƒèµ„æ–™\n\n1. [å¾®ä¿¡å°ç¨‹åºæˆæƒ](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/authorize.html)\n2. [å¾®ä¿¡å°ç¨‹åºå…¨å±€é…ç½®](https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/app.html#permission)\n"},{"id":"_ZDuShySVisiKi1uR6yOV","title":"å¾®å‰ç«¯qiankunä¸Šæ‰‹ä½“éªŒ","keywords":["å¾®å‰ç«¯"," single-spa"," qiankun"],"date":"2021-02-25","fileName":"qiankun","content":"\n> 1. [qiankun å®˜æ–¹æ–‡æ¡£](https://qiankun.umijs.org/zh)\n> 2. [single-spa](https://zh-hans.single-spa.js.org/docs/getting-started-overview/)\n> 3. [å¾®å‰ç«¯-æœ€å®¹æ˜“çœ‹æ‡‚çš„å¾®å‰ç«¯çŸ¥è¯†](https://juejin.cn/post/6844904162509979662#heading-0)\n\nå¾®å‰ç«¯çš„ç±»å‹ï¼š\n\n1. å—è·¯ç”±æ§åˆ¶æ¸²æŸ“çš„å­åº”ç”¨\n2. ä¸å—è·¯ç”±æ§åˆ¶çš„ç»„ä»¶\n3. éæ¸²æŸ“ç»„ä»¶ï¼Œåº”ç”¨é—´é€šä¿¡é€»è¾‘\n\n### 1.å­åº”ç”¨-vue\n\n#### 1. vue-cli åˆ›å»ºå­åº”ç”¨\n\n```shell\nvue create qiankun_vue\n```\n\n#### 2. ä¿®æ”¹å…¥å£`main.js`æ–‡ä»¶\n\n```javascript\n// https://qiankun.umijs.org/zh/guide/tutorial#vue-å¾®åº”ç”¨\nimport Vue from \"vue\";\nimport App from \"./App.vue\";\nimport router from \"./router\";\n\n// Vue.config.productionTip = false\n\nlet vueInstance = null;\nfunction render(props = {}) {\n  const { container } = props;\n\n  vueInstance = new Vue({\n    router,\n    render: (h) => h(App),\n    // è¿™é‡Œæ˜¯æŒ‚è½½åˆ°è‡ªå·±çš„htmlä¸Šï¼ŒåŸºåº§ä¼šæ‹¿åˆ°è¿™ä¸ªæŒ‚è½½åçš„htmlï¼Œå°†å…¶æ’å…¥åˆ°ç›¸åº”çš„å®¹å™¨é‡Œ\n\n    // Application died in status NOT_MOUNTED: Target container with #container not existed after xxx mounted!\n    // å¾®åº”ç”¨çš„æ ¹ id ä¸å…¶ä»– DOM å†²çªã€‚è§£å†³åŠæ³•æ˜¯ï¼šä¿®æ”¹æ ¹ id çš„æŸ¥æ‰¾èŒƒå›´ã€‚\n  }).$mount(container ? container.querySelector(\"#app\") : \"#app\");\n}\n\n// ä½¿ç”¨ webpack è¿è¡Œæ—¶ publicPath é…ç½®\n// åŠ¨æ€è®¾ç½®publicPath\nif (window.__POWERED_BY_QIANKUN__) {\n  __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;\n}\n\n// https://qiankun.umijs.org/zh/faq#å¦‚ä½•ç‹¬ç«‹è¿è¡Œå¾®åº”ç”¨ï¼Ÿ\nif (!window.__POWERED_BY_QIANKUN__) {\n  render();\n}\n\n// æš´éœ²3ä¸ªå¼‚æ­¥æ–¹æ³• bootstrap mount unmount\nexport async function bootstrap(props) {}\nexport async function mount(props) {\n  console.log(\"props=====>\", props);\n  render(props);\n}\nexport async function unmount(props) {\n  vueInstance && vueInstance.$destroy();\n}\n```\n\n#### 3. ä¿®æ”¹è·¯ç”±`router/index.js`æ–‡ä»¶\n\n```diff\n  const router = new VueRouter({\n    mode: 'history',\n-    base: process.env.BASE_URL,\n+    base: window.__POWERED_BY_QIANKUN__ ? '/vue' : process.env.BASE_URL,\n    routes\n  })\n\n```\n\n#### 4. æ ¹ç›®å½•æ–°å»º`vue.config.js`ï¼Œä¿®æ”¹æ‰“åŒ…é…ç½®\n\n```javascript\nmodule.exports = {\n  devServer: {\n    port: 8000,\n    headers: {\n      \"Access-Control-Allow-Origin\": \"*\",\n    },\n  },\n  // https://webpack.docschina.org/configuration/output/#outputlibrary\n  configureWebpack: {\n    output: {\n      library: \"vueApp\", // æ‰“åŒ…æˆä¸€ä¸ªç±»åº“\n      libraryTarget: \"umd\", // umdæœ€ç»ˆä¼šæŠŠbootstrap/mount/unmountæŒ‚è½½åˆ°windowä¸Š\n    },\n  },\n};\n```\n\n### 2.å­åº”ç”¨-react\n\n#### 1. create-react-app åˆ›å»ºå­åº”ç”¨\n\n```\ncreate-react-app qiankun_react\n```\n\n#### 2. ä¿®æ”¹å…¥å£`index.js`æ–‡ä»¶\n\n```javascript\nimport React from \"react\";\nimport ReactDOM from \"react-dom\";\nimport { BrowserRouter, Link, Route } from \"react-router-dom\";\nimport \"./index.css\";\nimport App from \"./App\";\n// import reportWebVitals from './reportWebVitals';\n\nfunction render(props) {\n  const { container } = props;\n  // https://reactrouter.com/web/api/BrowserRouter\n  ReactDOM.render(\n    <React.StrictMode>\n      <BrowserRouter basename=\"/react\">\n        <Link to=\"/\">react-home</Link> |<Link to=\"/about\">react-about</Link>\n        {/* exact ä¸¥æ ¼æ¨¡å¼ */}\n        <Route path=\"/\" exact render={() => <App />}></Route>\n        <Route\n          path=\"/about\"\n          exact\n          render={() => <div>react about page</div>}\n        ></Route>\n      </BrowserRouter>\n    </React.StrictMode>,\n    container\n      ? container.querySelector(\"#root\")\n      : document.querySelector(\"#root\")\n  );\n}\n\n// ç‹¬ç«‹è¿è¡Œ\nif (!window.__POWERED_BY_QIANKUN__) {\n  render();\n}\n\nexport async function bootstrap(props) {}\nexport async function mount(props) {\n  render(props);\n}\nexport async function unmount(props) {\n  const { container } = props;\n  ReactDOM.unmountComponentAtNode(\n    container\n      ? container.querySelector(\"#root\")\n      : document.querySelector(\"#root\")\n  );\n}\n```\n\n#### 3. ä¿®æ”¹æ‰“åŒ…é…ç½®æ–‡ä»¶\n\n##### 1. å®‰è£…`react-app-rewired`\n\n```shell\nyarn add react-app-rewired -D\n```\n\n##### 2. å­åº”ç”¨æ ¹ç›®å½•æ–°å»º`config-overrides.js`æ–‡ä»¶\n\n```javascript\n// https://github.com/timarney/react-app-rewired/blob/HEAD/README_zh.md#æ‰©å±•é…ç½®é€‰é¡¹\nmodule.exports = {\n  webpack: (config) => {\n    config.output.library = \"reactApp\";\n    config.output.libraryTarget = \"umd\";\n    config.output.publicPath = \"http://localhost:9000/\";\n    return config;\n  },\n  devServer: (configFunc) => {\n    return (proxy, allowedHost) => {\n      const config = configFunc(proxy, allowedHost);\n      // è®¾ç½®å¼€å‘æœåŠ¡å…è®¸è·¨åŸŸ\n      config.headers = {\n        \"Access-Control-Allow-Origin\": \"*\",\n      };\n\n      return config;\n    };\n  },\n};\n```\n\n##### 3. è®¾ç½®ç¯å¢ƒå˜é‡\n\n1. å­åº”ç”¨æ ¹ç›®å½•æ–°å»º`.env`æ–‡ä»¶\n\n```\nPORT=4000\nWDS_SOCKET_PORT=4000\n```\n\næˆ–è€…åœ¨`package.json`å¯åŠ¨è„šæœ¬ä¸­ä¿®æ”¹ç«¯å£\n\n```diff\n \"scripts\": {\n-     \"start\": \"react-app-rewired start\",\n+     \"start\": \"set PORT=4000 && react-app-rewired start\",\n   },\n```\n\n2. ä¿®æ”¹`package.json`æ–‡ä»¶\n\n```diff\n \"scripts\": {\n-     \"start\": \"react-scripts start\",\n-     \"build\": \"react-scripts build\",\n-     \"test\": \"react-scripts test\",\n-     \"eject\": \"react-scripts eject\"\n+     \"start\": \"react-app-rewired start\",\n+     \"build\": \"react-app-rewired build\",\n+     \"test\": \"react-app-rewired test\",\n+     \"eject\": \"react-app-rewired eject\"\n   },\n```\n\n### 3.å­åº”ç”¨(é webpack æ„å»º)-jquery+bootstrap\n\n#### 1. æ–°å»º`index.html`æ–‡ä»¶\n\n```html\n<!DOCTYPE html>\n<html lang=\"zh-CN\">\n  <head>\n    <meta charset=\"utf-8\" />\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n    <title>Bootstrap 101 Template</title>\n    <link href=\"//localhost:5000/lib/bootstrap.min.css\" rel=\"stylesheet\" />\n  </head>\n  <body>\n    <div class=\"container\" id=\"app\">\n      <h1>ä½ å¥½ï¼Œä¸–ç•Œï¼</h1>\n      <div class=\"row\">\n        <div class=\"input-group\">\n          <span class=\"input-group-addon\" id=\"basic-addon1\">@</span>\n          <input\n            type=\"text\"\n            class=\"form-control\"\n            placeholder=\"Username\"\n            aria-describedby=\"basic-addon1\"\n          />\n        </div>\n      </div>\n    </div>\n    <script src=\"//localhost:5000/lib/jquery.min.js\"></script>\n    <script src=\"//localhost:5000/lib/bootstrap.min.js\"></script>\n    <!--  entry jsä¸ºå…¥å£æ–‡ä»¶ -->\n    <script src=\"//localhost:5000/entry.js\"></script>\n  </body>\n</html>\n```\n\n#### 2. æ–°å»º`entry.js`å…¥å£æ–‡ä»¶\n\n```javascript\nconst render = ($) => {\n  $(\"#purehtml-container\").html(\"Hello, render with jQuery\");\n  return Promise.resolve();\n};\n((global) => {\n  global[\"purehtml\"] = {\n    bootstrap: () => {\n      console.log(\"purehtml bootstrap\");\n      return Promise.resolve();\n    },\n    mount: () => {\n      console.log(\"purehtml mount\");\n      return render($);\n    },\n    unmount: () => {\n      console.log(\"purehtml unmount\");\n      return Promise.resolve();\n    },\n  };\n})(window);\n```\n\n### 4.åŸºåº§åº”ç”¨-vue\n\n#### 1.ä¿®æ”¹å…¥å£`main.js`æ–‡ä»¶\n\n```diff\nimport Vue from 'vue'\nimport App from './App.vue'\nimport router from './router'\n+ import { registerMicroApps, start } from 'qiankun';\n+ import ElementUI from 'element-ui';\n+ import 'element-ui/lib/theme-chalk/index.css';\n\nVue.config.productionTip = false\n\n+ Vue.use(ElementUI);\n\n+ const apps = [\n+   {\n+     name: \"vueApp\",\n+     // é»˜è®¤é€šè¿‡fetchåŠ è½½è¿™ä¸ªhtmlï¼Œè§£æé‡Œé¢çš„jsï¼ŒåŠ¨æ€çš„æ‰§è¡Œ\n+     // æ³¨æ„ï¼šå­åº”ç”¨å¿…é¡»æ”¯æŒè·¨åŸŸ\n+     entry: \"http://localhost:8000\",\n+     container: \"#vueDOM\", // å®¹å™¨å\n+     activeRule: \"/vue\", // æ¿€æ´»è·¯å¾„\n+     props: { a: 1, b: 2 }, // ä¼ ç»™å­åº”ç”¨çš„å‚æ•°\n+   },\n+   {\n+     name: \"reactApp\",\n+     entry: \"//localhost:9000\",\n+     container: \"#react\",\n+     activeRule: \"/react\",\n+   },\n+   {\n+     name: \"jqueryApp\",\n+     entry: \"//localhost:5000\",\n+     container: \"#jquery\",\n+     activeRule: \"/jquery\",\n+     props: { a: 100, b: 200 },\n+   },\n+ ];\n+\n+ registerMicroApps(apps); // æ³¨å†Œåº”ç”¨\n+ // å¯åŠ¨åº”ç”¨\n+ start({\n+   // https://qiankun.umijs.org/zh/api#startopts\n+   prefetch: false, // å–æ¶ˆé¢„åŠ è½½\n+ });\n\nnew Vue({\n  router,\n  render: h => h(App)\n}).$mount('#app')\n```\n\n#### 2. ä¿®æ”¹`App.vue`ç»„ä»¶\n\n```html\n<template>\n  <div id=\"app\">\n    <el-menu :router=\"true\" mode=\"horizontal\">\n      <!-- åŸºåº§è‡ªå·±çš„è·¯ç”± -->\n      <el-menu-item index=\"/\">base-home</el-menu-item>\n      <el-menu-item index=\"/about\">base-about</el-menu-item>\n      <!-- å¼•ç”¨å…¶ä»–å­åº”ç”¨ -->\n      <el-menu-item index=\"/vue\">vue åº”ç”¨</el-menu-item>\n      <el-menu-item index=\"/react\">react åº”ç”¨</el-menu-item>\n      <el-menu-item index=\"/jquery\">jquery + bootstrap åº”ç”¨</el-menu-item>\n    </el-menu>\n\n    <router-view />\n\n    <div id=\"vueDOM\"></div>\n    <div id=\"react\"></div>\n    <div id=\"jquery\"></div>\n  </div>\n</template>\n```\n"}]}